local lib = {}
local cloneref = cloneref or function(x) return x end

-- Cache services once at startup for better performance
local UserInputService = cloneref(game:GetService("UserInputService"))
local TweenService = cloneref(game:GetService("TweenService"))
local CoreGui = cloneref(game:GetService("CoreGui"))
local RunService = cloneref(game:GetService("RunService"))

-- Security: Verify execution environment
if not RunService:IsStudio() and not UserInputService.GamepadEnabled then
    return lib
end

local DEFAULT_PRESET_COLOR = Color3.fromRGB(44, 120, 224)
local DEFAULT_CLOSE_BIND = Enum.KeyCode.RightControl
local connections = {} -- Store connections for cleanup

-- Helper function to safely disconnect events
local function disconnectAll()
    for _, conn in ipairs(connections) do
        if conn.Connected then
            conn:Disconnect()
        end
    end
    table.clear(connections)
end

-- Optimized instance creation with memory efficiency
local function createInstance(className, properties, parent)
    local instance = Instance.new(className)
    if properties then
        for prop, value in pairs(properties) do
            instance[prop] = value
        end
    end
    if parent then
        instance.Parent = parent
    end
    return instance
end

-- Optimized tween helper with connection management
local function tween(instance, properties, time, easeStyle, easeDirection)
    easeStyle = easeStyle or Enum.EasingStyle.Quad
    easeDirection = easeDirection or Enum.EasingDirection.Out
    time = time or 0.3
    
    local tweenInfo = TweenInfo.new(time, easeStyle, easeDirection)
    local animation = TweenService:Create(instance, tweenInfo, properties)
    animation:Play()
    return animation
end

-- Optimized draggable implementation
local function makeDraggable(dragElement, targetElement)
    local dragging, dragInput, dragStart, startPos
    
    local inputBegan = dragElement.InputBegan:Connect(function(input)
        if (input.UserInputType == Enum.UserInputType.MouseButton1 or 
            input.UserInputType == Enum.UserInputType.Touch) and 
           not input.UserCouldBeManipulating then
            
            dragging = true
            dragStart = input.Position
            startPos = targetElement.Position
            
            local inputChanged = input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    if inputChanged.Connected then
                        inputChanged:Disconnect()
                    end
                end
            end)
            table.insert(connections, inputChanged)
        end
    end)
    
    table.insert(connections, inputBegan)
    
    local inputChanged = dragElement.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or 
           input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    table.insert(connections, inputChanged)
    
    local userInputChanged = UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            targetElement.Position = UDim2.new(
                startPos.X.Scale, startPos.X.Offset + delta.X,
                startPos.Y.Scale, startPos.Y.Offset + delta.Y
            )
        end
    end)
    table.insert(connections, userInputChanged)
end

-- Optimized number formatting for sliders
local function formatNumber(value, increment)
    if math.abs(value) < 0.0001 and value ~= 0 then
        return string.format("%.2e", value)
    end
    
    if increment and increment < 1 then
        local decimalPlaces = math.max(0, math.min(6, -math.floor(math.log10(increment))))
        return string.format("%." .. decimalPlaces .. "f", value)
    end
    
    return tostring(math.floor(value))
end

function lib:Window(title, presetColor, closeBind)
    -- Handle existing instance cleanup
    if CoreGui:FindFirstChild("67Library") then
        CoreGui:FindFirstChild("67Library"):Destroy()
    end
    
    -- Setup main UI container
    local ui = createInstance("ScreenGui", {
        Name = "67Library",
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        ResetOnSpawn = false
    }, CoreGui)
    
    -- Configuration
    local currentPresetColor = presetColor or DEFAULT_PRESET_COLOR
    local currentCloseBind = closeBind or DEFAULT_CLOSE_BIND
    local isMobile = UserInputService.TouchEnabled
    local isUIVisible = true
    
    -- Create main window
    local mainWindow = createInstance("Frame", {
        Name = "Main",
        BackgroundColor3 = Color3.fromRGB(45, 45, 45),
        BorderSizePixel = 0,
        Position = UDim2.new(0.5, 0, 0.5, 0),
        Size = UDim2.new(0, 560, 0, 319),
        ClipsDescendants = true,
        AnchorPoint = Vector2.new(0.5, 0.5)
    })
    
    -- Add visual styling
    createInstance("UICorner", {CornerRadius = UDim.new(0, 8)}, mainWindow)
    
    -- Mobile toggle button (only if needed)
    local mobileToggle
    if isMobile then
        mobileToggle = createInstance("TextButton", {
            Size = UDim2.new(0, 40, 0, 40),
            Position = UDim2.new(1, -50, 0, 10),
            AnchorPoint = Vector2.new(1, 0),
            BackgroundColor3 = Color3.fromRGB(54, 54, 54),
            Text = "−",
            TextColor3 = currentPresetColor,
            Font = Enum.Font.GothamBold,
            TextSize = 20,
            AutoButtonColor = false
        })
        
        createInstance("UICorner", {CornerRadius = UDim.new(0, 8)}, mobileToggle)
        createInstance("UIStroke", {
            Color = currentPresetColor,
            Thickness = 2,
            ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        }, mobileToggle)
        
        -- Mobile toggle functionality
        mobileToggle.MouseButton1Click:Connect(function()
            isUIVisible = not isUIVisible
            mainWindow.Visible = isUIVisible
            mobileToggle.Text = isUIVisible and "−" or "+"
            
            tween(mobileToggle, {
                BackgroundColor3 = isUIVisible and Color3.fromRGB(54, 54, 54) or currentPresetColor
            }, 0.3)
        end)
        
        -- Make mobile toggle draggable
        makeDraggable(mobileToggle, mobileToggle)
        mobileToggle.Parent = ui
    end
    
    -- Window drag functionality
    local dragFrame = createInstance("Frame", {
        BackgroundTransparency = 1,
        Size = UDim2.new(1, 0, 0, 41)
    }, mainWindow)
    
    makeDraggable(dragFrame, mainWindow)
    
    -- Window title
    createInstance("TextLabel", {
        BackgroundTransparency = 1,
        Position = UDim2.new(0.034, 0, 0.056, 0),
        Size = UDim2.new(0, 200, 0, 23),
        Font = Enum.Font.GothamSemibold,
        Text = title,
        TextColor3 = Color3.fromRGB(100, 100, 100),
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left
    }, mainWindow)
    
    -- Tab system
    local tabHolder = createInstance("ScrollingFrame", {
        BackgroundTransparency = 1,
        Position = UDim2.new(0.034, 0, 0.147, 0),
        Size = UDim2.new(0, 107, 0, 254),
        CanvasSize = UDim2.new(0, 0, 0, 0),
        ScrollBarThickness = 3,
        ScrollBarImageColor3 = Color3.fromRGB(80, 80, 80)
    }, mainWindow)
    
    local tabLayout = createInstance("UIListLayout", {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 11)
    }, tabHolder)
    
    tabLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        tabHolder.CanvasSize = UDim2.new(0, 0, 0, tabLayout.AbsoluteContentSize.Y)
    end)
    
    local tabFolder = createInstance("Folder", {Name = "Tabs"}, mainWindow)
    local firstTab = true
    
    -- Close binding
    local closeConn = UserInputService.InputBegan:Connect(function(input, processed)
        if not processed and input.KeyCode == currentCloseBind then
            isUIVisible = not isUIVisible
            mainWindow.Visible = isUIVisible
            
            if isMobile and mobileToggle then
                mobileToggle.Text = isUIVisible and "−" or "+"
            end
        end
    end)
    table.insert(connections, closeConn)
    
    -- Main window visibility
    mainWindow.Parent = ui
    
    -- Tab creation function
    local function createTab(tabTitle)
        -- Tab button
        local tabButton = createInstance("TextButton", {
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 0, 21),
            Text = ""
        })
        
        local tabLabel = createInstance("TextLabel", {
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            Font = Enum.Font.Gotham,
            Text = tabTitle,
            TextColor3 = Color3.fromRGB(180, 180, 180),
            TextSize = 14,
            TextXAlignment = Enum.TextXAlignment.Left
        }, tabButton)
        
        local indicator = createInstance("Frame", {
            BackgroundColor3 = currentPresetColor,
            BorderSizePixel = 0,
            Position = UDim2.new(0, 0, 1, 0),
            Size = UDim2.new(0, 0, 0, 2)
        }, tabButton)
        
        createInstance("UICorner", {CornerRadius = UDim.new(0, 2)}, indicator)
        
        -- Tab content
        local tabContent = createInstance("ScrollingFrame", {
            BackgroundTransparency = 1,
            Position = UDim2.new(0.314, 0, 0.147, 0),
            Size = UDim2.new(0, 373, 0, 254),
            CanvasSize = UDim2.new(0, 0, 0, 0),
            ScrollBarThickness = 3,
            ScrollBarImageColor3 = Color3.fromRGB(80, 80, 80),
            Visible = false
        }, tabFolder)
        
        local contentLayout = createInstance("UIListLayout", {
            SortOrder = Enum.SortOrder.LayoutOrder,
            Padding = UDim.new(0, 6)
        }, tabContent)
        
        contentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            tabContent.CanvasSize = UDim2.new(0, 0, 0, contentLayout.AbsoluteContentSize.Y)
        end)
        
        -- Tab activation
        tabButton.MouseButton1Click:Connect(function()
            for _, child in ipairs(tabFolder:GetChildren()) do
                if child:IsA("ScrollingFrame") then
                    child.Visible = false
                end
            end
            
            for _, btn in ipairs(tabHolder:GetChildren()) do
                if btn:IsA("TextButton") then
                    local btnIndicator = btn:FindFirstChild("Frame")
                    if btnIndicator then
                        tween(btnIndicator, {Size = UDim2.new(0, 0, 0, 2)}, 0.2, Enum.EasingStyle.Quart)
                    end
                    
                    local label = btn:FindFirstChild("TextLabel")
                    if label then
                        tween(label, {TextColor3 = Color3.fromRGB(180, 180, 180)}, 0.3)
                    end
                end
            end
            
            tabContent.Visible = true
            tween(indicator, {Size = UDim2.new(0, 13, 0, 2)}, 0.2, Enum.EasingStyle.Quart)
            tween(tabLabel, {TextColor3 = Color3.fromRGB(255, 255, 255)}, 0.3)
        end)
        
        tabButton.Parent = tabHolder
        
        -- Select first tab by default
        if firstTab then
            firstTab = false
            tabButton.MouseButton1Click:Fire()
        end
        
        -- Tab content functions
        local tabAPI = {}
        
        function tabAPI:Label(text)
            return createInstance("TextLabel", {
                BackgroundTransparency = 1,
                Size = UDim2.new(1, -10, 0, 30),
                Font = Enum.Font.Gotham,
                Text = text,
                TextColor3 = Color3.fromRGB(200, 200, 200),
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Center
            }, tabContent)
        end
        
        function tabAPI:Button(text, callback)
            local button = createInstance("TextButton", {
                BackgroundColor3 = Color3.fromRGB(54, 54, 54),
                Size = UDim2.new(1, -10, 0, 42),
                AutoButtonColor = false,
                Text = ""
            })
            
            createInstance("UICorner", {CornerRadius = UDim.new(0, 6)}, button)
            
            createInstance("TextLabel", {
                BackgroundTransparency = 1,
                Position = UDim2.new(0.036, 0, 0, 0),
                Size = UDim2.new(0, 187, 1, 0),
                Font = Enum.Font.Gotham,
                Text = text,
                TextColor3 = Color3.fromRGB(255, 255, 255),
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            }, button)
            
            button.MouseEnter:Connect(function()
                tween(button, {BackgroundColor3 = Color3.fromRGB(64, 64, 64)}, 0.3)
            end)
            
            button.MouseLeave:Connect(function()
                tween(button, {BackgroundColor3 = Color3.fromRGB(54, 54, 54)}, 0.2)
            end)
            
            button.MouseButton1Click:Connect(function()
                if typeof(callback) == "function" then
                    pcall(callback)
                end
            end)
            
            button.Parent = tabContent
            return button
        end
        
        function tabAPI:Toggle(text, defaultState, callback)
            local currentState = defaultState or false
            local toggle = createInstance("TextButton", {
                BackgroundColor3 = Color3.fromRGB(54, 54, 54),
                Size = UDim2.new(1, -10, 0, 42),
                AutoButtonColor = false,
                Text = ""
            })
            
            createInstance("UICorner", {CornerRadius = UDim.new(0, 6)}, toggle)
            
            createInstance("TextLabel", {
                BackgroundTransparency = 1,
                Position = UDim2.new(0.036, 0, 0, 0),
                Size = UDim2.new(0, 187, 1, 0),
                Font = Enum.Font.Gotham,
                Text = text,
                TextColor3 = Color3.fromRGB(255, 255, 255),
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            }, toggle)
            
            local background = createInstance("Frame", {
                BackgroundColor3 = Color3.fromRGB(70, 70, 70),
                Position = UDim2.new(0.86, 0, 0.286, 0),
                Size = UDim2.new(0, 37, 0, 18)
            }, toggle)
            
            createInstance("UICorner", {CornerRadius = UDim.new(1, 0)}, background)
            
            local slider = createInstance("Frame", {
                BackgroundColor3 = Color3.fromRGB(54, 54, 54),
                Position = UDim2.new(0.049, 0, 0.093, 0),
                Size = UDim2.new(0, 33, 0, 14)
            }, background)
            
            createInstance("UICorner", {CornerRadius = UDim.new(1, 0)}, slider)
            
            local activeState = createInstance("Frame", {
                BackgroundColor3 = currentPresetColor,
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 1, 0)
            }, background)
            
            createInstance("UICorner", {CornerRadius = UDim.new(1, 0)}, activeState)
            
            local circle = createInstance("Frame", {
                BackgroundColor3 = Color3.fromRGB(70, 70, 70),
                Position = UDim2.new(0.127, 0, 0.222, 0),
                Size = UDim2.new(0, 10, 0, 10)
            }, background)
            
            createInstance("UICorner", {CornerRadius = UDim.new(1, 0)}, circle)
            
            local function updateVisualState()
                local targetColor = currentState and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(70, 70, 70)
                local targetPos = currentState and UDim2.new(0.587, 0, 0.222, 0) or UDim2.new(0.127, 0, 0.222, 0)
                local bgTransparency = currentState and 1 or 0
                local activeTransparency = currentState and 0 or 1
                
                tween(toggle, {BackgroundColor3 = currentState and Color3.fromRGB(64, 64, 64) or Color3.fromRGB(54, 54, 54)}, 0.3)
                tween(background, {BackgroundTransparency = bgTransparency}, 0.3)
                tween(slider, {BackgroundTransparency = bgTransparency}, 0.3)
                tween(activeState, {BackgroundTransparency = activeTransparency}, 0.3)
                tween(circle, {BackgroundColor3 = targetColor, Position = targetPos}, 0.3, Enum.EasingStyle.Quart)
                
                if typeof(callback) == "function" then
                    pcall(callback, currentState)
                end
            end
            
            toggle.MouseButton1Click:Connect(function()
                currentState = not currentState
                updateVisualState()
            end)
            
            updateVisualState()
            
            toggle.Parent = tabContent
            
            return {
                Set = function(self, newState)
                    if currentState ~= newState then
                        currentState = newState
                        updateVisualState()
                    end
                end,
                Get = function() return currentState end
            }
        end
        
        function tabAPI:Slider(text, minValue, maxValue, increment, callback)
            increment = increment or 1
            local currentValue = minValue
            local dragging = false
            
            local slider = createInstance("TextButton", {
                BackgroundColor3 = Color3.fromRGB(54, 54, 54),
                Size = UDim2.new(1, -10, 0, 62),
                AutoButtonColor = false,
                Text = ""
            })
            
            createInstance("UICorner", {CornerRadius = UDim.new(0, 6)}, slider)
            
            createInstance("TextLabel", {
                BackgroundTransparency = 1,
                Position = UDim2.new(0.036, 0, 0.1, 0),
                Size = UDim2.new(0, 187, 0, 30),
                Font = Enum.Font.Gotham,
                Text = text,
                TextColor3 = Color3.fromRGB(255, 255, 255),
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            }, slider)
            
            local valueLabel = createInstance("TextLabel", {
                BackgroundTransparency = 1,
                Position = UDim2.new(0.036, 0, 0.1, 0),
                Size = UDim2.new(1, -10, 0, 30),
                Font = Enum.Font.Gotham,
                Text = formatNumber(currentValue, increment),
                TextColor3 = Color3.fromRGB(255, 255, 255),
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Right
            }, slider)
            
            local track = createInstance("Frame", {
                BackgroundColor3 = Color3.fromRGB(70, 70, 70),
                BorderSizePixel = 0,
                Position = UDim2.new(0.034, 0, 0.645, 0),
                Size = UDim2.new(1, -24, 0, 5)
            }, slider)
            
            createInstance("UICorner", {CornerRadius = UDim.new(1, 0)}, track)
            
            local progress = createInstance("Frame", {
                BackgroundColor3 = currentPresetColor,
                BorderSizePixel = 0,
                Size = UDim2.new(0, 0, 1, 0)
            }, track)
            
            createInstance("UICorner", {CornerRadius = UDim.new(1, 0)}, progress)
            
            local thumb = createInstance("ImageButton", {
                BackgroundTransparency = 1,
                Position = UDim2.new(0, -6, 0.5, -6),
                Size = UDim2.new(0, 12, 0, 12),
                Image = "rbxassetid://3570695787",
                ImageColor3 = currentPresetColor,
                ScaleType = Enum.ScaleType.Fit,
                ZIndex = 2
            }, track)
            
            local function setValue(newValue)
                newValue = math.clamp(newValue, minValue, maxValue)
                if increment > 0 then
                    newValue = math.floor(newValue / increment) * increment
                end
                
                currentValue = newValue
                local progressPercent = (newValue - minValue) / (maxValue - minValue)
                
                tween(progress, {Size = UDim2.new(progressPercent, 0, 1, 0)}, 0.1)
                tween(thumb, {Position = UDim2.new(progressPercent, -6, 0.5, -6)}, 0.1)
                valueLabel.Text = formatNumber(newValue, increment)
                
                if typeof(callback) == "function" and not dragging then
                    pcall(callback, newValue)
                end
            end
            
            local function startDrag(input)
                dragging = true
                tween(slider, {BackgroundColor3 = Color3.fromRGB(64, 64, 64)}, 0.2)
                
                local function updatePosition(inputPos)
                    local trackPos = track.AbsolutePosition.X
                    local trackSize = track.AbsoluteSize.X
                    local relativePos = math.clamp(inputPos.X - trackPos, 0, trackSize)
                    local percent = relativePos / trackSize
                    local newValue = minValue + percent * (maxValue - minValue)
                    setValue(newValue)
                end
                
                updatePosition(input.Position)
                
                local moveConn
                moveConn = UserInputService.InputChanged:Connect(function(input)
                    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or 
                                   input.UserInputType == Enum.UserInputType.Touch) then
                        updatePosition(input.Position)
                    end
                end)
                
                local endConn
                endConn = UserInputService.InputEnded:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 or 
                       input.UserInputType == Enum.UserInputType.Touch then
                        
                        dragging = false
                        if moveConn.Connected then moveConn:Disconnect() end
                        if endConn.Connected then endConn:Disconnect() end
                        
                        tween(slider, {BackgroundColor3 = Color3.fromRGB(54, 54, 54)}, 0.2)
                        
                        if typeof(callback) == "function" then
                            pcall(callback, currentValue)
                        end
                    end
                end)
            end
            
            thumb.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or 
                   input.UserInputType == Enum.UserInputType.Touch then
                    startDrag(input)
                end
            end)
            
            track.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or 
                   input.UserInputType == Enum.UserInputType.Touch then
                    startDrag(input)
                end
            end)
            
            slider.MouseEnter:Connect(function()
                if not dragging then
                    tween(slider, {BackgroundColor3 = Color3.fromRGB(64, 64, 64)}, 0.3)
                end
            end)
            
            slider.MouseLeave:Connect(function()
                if not dragging then
                    tween(slider, {BackgroundColor3 = Color3.fromRGB(54, 54, 54)}, 0.2)
                end
            end)
            
            setValue(minValue)
            
            slider.Parent = tabContent
            
            return {
                Set = function(self, newValue)
                    setValue(newValue)
                end,
                Get = function() return currentValue end
            }
        end
        
        function tabAPI:Dropdown(text, items, callback)
            local isOpen = false
            local dropdown = createInstance("Frame", {
                BackgroundColor3 = Color3.fromRGB(54, 54, 54),
                Size = UDim2.new(1, -10, 0, 42)
            })
            
            createInstance("UICorner", {CornerRadius = UDim.new(0, 6)}, dropdown)
            
            local button = createInstance("TextButton", {
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 1, 0),
                Text = ""
            }, dropdown)
            
            local label = createInstance("TextLabel", {
                BackgroundTransparency = 1,
                Position = UDim2.new(0.036, 0, 0, 0),
                Size = UDim2.new(0, 187, 1, 0),
                Font = Enum.Font.Gotham,
                Text = text,
                TextColor3 = Color3.fromRGB(255, 255, 255),
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            }, button)
            
            local arrow = createInstance("ImageLabel", {
                BackgroundTransparency = 1,
                Position = UDim2.new(1.652, 0, 0.19, 0),
                Size = UDim2.new(0, 26, 0, 26),
                Image = "http://www.roblox.com/asset/?id=6034818375"
            }, label)
            
            local list = createInstance("ScrollingFrame", {
                BackgroundTransparency = 1,
                Position = UDim2.new(-0.004, 0, 1.05, 0),
                Size = UDim2.new(1, 0, 0, 0),
                CanvasSize = UDim2.new(0, 0, 0, 0),
                ScrollBarThickness = 3,
                ScrollBarImageColor3 = Color3.fromRGB(80, 80, 80),
                ClipsDescendants = true
            }, label)
            
            local listLayout = createInstance("UIListLayout", {
                SortOrder = Enum.SortOrder.LayoutOrder,
                Padding = UDim.new(0, 4)
            }, list)
            
            button.MouseButton1Click:Connect(function()
                isOpen = not isOpen
                local targetSize = isOpen and UDim2.new(1, -10, 0, 42 + listLayout.AbsoluteContentSize.Y + 10) or UDim2.new(1, -10, 0, 42)
                
                tween(dropdown, {Size = targetSize}, 0.2, Enum.EasingStyle.Quart)
                tween(arrow, {Rotation = isOpen and 270 or 0}, 0.3)
            end)
            
            for _, itemText in ipairs(items) do
                local item = createInstance("TextButton", {
                    BackgroundColor3 = Color3.fromRGB(54, 54, 54),
                    Size = UDim2.new(1, -10, 0, 25),
                    AutoButtonColor = false,
                    Font = Enum.Font.Gotham,
                    Text = itemText,
                    TextColor3 = Color3.fromRGB(255, 255, 255),
                    TextSize = 15
                })
                
                createInstance("UICorner", {CornerRadius = UDim.new(0, 4)}, item)
                
                item.MouseEnter:Connect(function()
                    tween(item, {BackgroundColor3 = Color3.fromRGB(64, 64, 64)}, 0.3)
                end)
                
                item.MouseLeave:Connect(function()
                    tween(item, {BackgroundColor3 = Color3.fromRGB(54, 54, 54)}, 0.3)
                end)
                
                item.MouseButton1Click:Connect(function()
                    isOpen = false
                    label.Text = text .. " - " .. itemText
                    dropdown.Size = UDim2.new(1, -10, 0, 42)
                    tween(arrow, {Rotation = 0}, 0.3)
                    
                    if typeof(callback) == "function" then
                        pcall(callback, itemText)
                    end
                end)
                
                item.Parent = list
            end
            
            listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                list.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y)
            end)
            
            dropdown.Parent = tabContent
            return dropdown
        end
        
        function tabAPI:Textbox(text, callback)
            local textboxFrame = createInstance("Frame", {
                BackgroundColor3 = Color3.fromRGB(54, 54, 54),
                Size = UDim2.new(1, -10, 0, 42)
            })
            
            createInstance("UICorner", {CornerRadius = UDim.new(0, 6)}, textboxFrame)
            
            createInstance("TextLabel", {
                BackgroundTransparency = 1,
                Position = UDim2.new(0.036, 0, 0, 0),
                Size = UDim2.new(0, 187, 1, 0),
                Font = Enum.Font.Gotham,
                Text = text,
                TextColor3 = Color3.fromRGB(255, 255, 255),
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left
            }, textboxFrame)
            
            local inputFrame = createInstance("Frame", {
                BackgroundColor3 = Color3.fromRGB(64, 64, 64),
                Position = UDim2.new(0.86, 0, 0.214, 0),
                Size = UDim2.new(0, 100, 0, 23)
            }, textboxFrame)
            
            createInstance("UICorner", {CornerRadius = UDim.new(0, 5)}, inputFrame)
            
            local inputBox = createInstance("TextBox", {
                BackgroundTransparency = 1,
                Size = UDim2.new(1, 0, 1, 0),
                Font = Enum.Font.Gotham,
                Text = "",
                TextColor3 = Color3.fromRGB(255, 255, 255),
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Center,
                ClearTextOnFocus = false
            }, inputFrame)
            
            inputBox.FocusLost:Connect(function(enterPressed)
                if enterPressed and #inputBox.Text > 0 and typeof(callback) == "function" then
                    pcall(callback, inputBox.Text)
                end
            end)
            
            textboxFrame.Parent = tabContent
            return inputBox
        end
        
        return tabAPI
    end
    
    -- Library cleanup function
    function lib:Destroy()
        disconnectAll()
        if ui and ui.Parent then
            ui:Destroy()
        end
    end
    
    return {
        Tab = createTab
    }
end

return lib